<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

    <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Unit Tests. Data provider без головной боли &middot; Fightmaster's blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38362255-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



    <!--<script type="text/javascript">-->
        <!--/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */-->
        <!--var disqus_shortname = 'fightmaster'; // required: replace example with your forum shortname-->

        <!--/* * * DON'T EDIT BELOW THIS LINE * * */-->
        <!--(function () {-->
            <!--var s = document.createElement('script'); s.async = true;-->
            <!--s.type = 'text/javascript';-->
            <!--s.src = '//' + disqus_shortname + '.disqus.com/count.js';-->
            <!--(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);-->
        <!--}());-->
    <!--</script>-->
  <!-- Put this script tag to the <head> of your page -->
  <script type="text/javascript" src="//vk.com/js/api/openapi.js?136"></script>

  <script type="text/javascript">
      VK.init({apiId: 5813923, onlyWidgets: true});
  </script>
</head>


    <body>

        <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
            <img src="/public/avatar.jpeg">
        </a>
      </h1>
      <p class="lead">Скромный персональный блог <a href="https://twitter.com/old_fightmaster" target="_blank">@old_fightmaster</a></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Блог</a>
      <a class="sidebar-nav-item" href="/php-lectures/00-contents.html">PHP-лекции</a>
      <a class="sidebar-nav-item" href="/recommendations/for-junior-php-developer.html">Рекомендации по php</a>
      <a class="sidebar-nav-item" href="/blog/archives/index.html">Архив</a>

      

      <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/blog/archives/">Blog Archive</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/life/">Category: life</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/blog/">Category: blog</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/php/">Category: php</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/lectures/">Category: lectures</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/nginx/">Category: nginx</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/symfony2/">Category: symfony2</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/ubuntu/">Category: ubuntu</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/usa/">Category: usa</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/design-patterns/">Category: design patterns</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/unit-tests/">Category: unit tests</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/code-review/">Category: code review</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/clean-code/">Category: clean code</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/handbook/">Category: handbook</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/sport/">Category: sport</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/run/">Category: run</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/data-provider/">Category: data provider</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/refactoring/">Category: refactoring</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/amazon/">Category: amazon</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/kindle-paperwhite/">Category: kindle paperwhite</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/boolean-attribute/">Category: boolean attribute</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/opensoft/">Category: opensoft</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/recommendations/">Category: recommendations</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/git/">Category: git</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/merge/">Category: merge</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/high-load/">Category: high load</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/optimization/">Category: optimization</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/in-array/">Category: in_array</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/array-key-exists/">Category: array_key_exists</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/zhizn/">Category: жизнь</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
            <!--<a class="sidebar-nav-item" href="/categories/sport/">Category: спорт</a>-->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
        <!---->
          <!---->
        <!---->
      <!---->
    </nav>

    <p>&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
        <div class="post">
  <h1 class="post-title">Unit Tests. Data provider без головной боли</h1>
  <span class="post-date">05 Oct 2013</span>
  <p>Недавно текущий проект перевалил за 1500 юнит тестов. Захотелось подвести какой-то итог. И сегодня не будет какого-то рецепта: &quot;А делайте так - получите счастье&quot;. Посмотрим на примерах, как можно сделать что-то иначе. Внимание, очень много странных букв под php синтаксисом.</p>

<!-- more -->

<p>Мы с вами не на пробежке, разогреваться нам не надо, начнем сразу с кода. Примеры вымышленные, и я буду использовать аббревиатуру uut (Unit Under Test).</p>

<h3>isPositiveNumber($number)</h3>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">isPositiveNumber</span><span class="p">(</span><span class="nv">$number</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nv">$number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Тест мог бы выглядеть так:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">isPositiveNumber</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">isPositiveNumber</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">isPositiveNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">isPositiveNumber</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Или так:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">isPositiveNumberTrueScenario</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">isPositiveNumber</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">isPositiveNumberFalseScenario</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">isPositiveNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">isPositiveNumber</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Мы пишем и пишем так тесты, пока кто-то не прочитает официальную документацию и не узнает, а что такое Data Providers: <a href="http://phpunit.de/manual/3.7/en/writing-tests-for-phpunit.html#writing-tests-for-phpunit.data-providers">phpunit.de</a>. Чаще всего нам необходимо протестировать метод с разными входными данными и проверить результат. Вот для избежания дублирования тестов и придумали эти провайдеры.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> * @dataProvider isPositiveNumberProvider</span>
<span class="sd"> *</span>
<span class="sd"> * @param integer $inputData</span>
<span class="sd"> * @param boolean $expectedResult</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">isPositiveNumber</span><span class="p">(</span><span class="nv">$inputData</span><span class="p">,</span> <span class="nv">$expectedResult</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">isPositiveNumber</span><span class="p">(</span><span class="nv">$inputData</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$expectedResult</span><span class="p">,</span> <span class="nv">$result</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">isPositiveNumberProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">true</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">false</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Кажется мы нашли решение для всего и плодим тесты одни за другим...</p>

<h3>Простота - залог успеха</h3>

<p>Написав первую главу, я понял, что не могу придумать адекватный пример для второй. А по ощущениям, я большую часть жизни так писал. Несколько дней искал объяснение этому факту. Пришел к выводу, что наш код со временем стал чище, и такие тесты практически вымерли. </p>

<p>Отступление... В день выпуска статьи у меня был небольшой митинг с коллегой, который завершился словами: &quot;Если разбить метод на три, как я предложил, то и с тестированием проблем не будет&quot;. Не могу утверждать, что мои слова действительно помогут, но они заставили меня еще раз задуматься о необходимости писать тесты.</p>

<p>Беря любой старый пример, я понимаю, что можно было написать по-другому. Или, как я недавно начал говорить, &quot;выпендриться&quot; и написать код мечты. Поэтому придется пойти на откровения дальше, взяв не самый хороший код из жизни. </p>

<h3>Юнит тесты поздней осенью</h3>

<p>Утро, поздняя осень, за окном холодно и темно. Вы приходите на работу в часов эдак семь или раньше. Идете на кухню, наливаете себе кофе, медленно и молчаливо пьете, с коллегой, девушкой, думая о том, что надо бы написать к коду тест.</p>

<p>Когда-то и кто-то что-то написал, дальше всем миром это апгрейдили, апгрейдили, а вчера вам пришлось снова что-то туда добавить. При этом вы были уставший, и вам срать было на этот старый код. Да и сейчас, наверное, особенно отношение не изменилось, просто ночью проснулся профессионализм.</p>

<p>Медленно мысли о &quot;надо написать&quot; перерастают в &quot;как написать&quot;. В голове прокручиваются воспоминания о том, а что же делает код. У вас есть некие данные, из которых собирается какая-то сущность. При этом накладывается куча всевозможных &quot;бизнес&quot; ограничений на входную информацию. Что-то вроде сахар не может быть синим, а картошка не может доставлена в ресторан без лука, а помол кофе может быть лишь трех видов, а третий вид поставляется только из Африки. Вроде и валидация, а с другой стороны ничего стандартного не прикрепишь.</p>

<p>В итоге в отведенные два часа из трех вы вчера написали что-то наподобие этому, plain php.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @param Model $model</span>
<span class="sd"> * @throws CustomException</span>
<span class="sd"> */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">checkSomethingRestrictions</span><span class="p">(</span><span class="nx">Model</span> <span class="nv">$model</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$linkedModel</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getLinkedModel</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$linkedModel</span> <span class="o">&amp;&amp;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">hasSomething</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">CustomException</span><span class="p">(</span><span class="s1">&#39;Failed 1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//code - code - code</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">isEnabled</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$something</span> <span class="o">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">CustomException</span><span class="p">(</span><span class="s1">&#39;Failed 17&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Проснувшись и преодолев чувство стыда за написанное, вы пишите быстренько тест.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> * @dataProvider checkSomethingRestrictionsProvider</span>
<span class="sd"> *</span>
<span class="sd"> * @param string $modelReference</span>
<span class="sd"> * @param string $exceptionMessage</span>
<span class="sd"> * @param integer|null $exceptionCode</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">checkSomethingRestrictions</span><span class="p">(</span><span class="nv">$modelReference</span><span class="p">,</span> <span class="nv">$exceptionMessage</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$exceptionCode</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$exceptionMessage</span> <span class="o">!==</span> <span class="k">null</span> <span class="o">||</span> <span class="nv">$exceptionCode</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setExpectedException</span><span class="p">(</span><span class="s1">&#39;CustomException&#39;</span><span class="p">,</span> <span class="nv">$exceptionMessage</span><span class="p">,</span> <span class="nv">$exceptionCode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$model</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">referenceRepository</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="nv">$modelReference</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">checkSomethingRestrictions</span><span class="p">(</span><span class="nv">$model</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">checkSomethingRestrictionsProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_2&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_3&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_4&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_5&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_6&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_7&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_8&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_9&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 2&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 3&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 5&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 4&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_6&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 6&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_7&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 7&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_8&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 8&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_9&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 9&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_10&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 10&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_11&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 11&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_12&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 12&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_13&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 13&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_14&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 14&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_15&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 15&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_16&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 16&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_17&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 17&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Конечно, слово &quot;быстро&quot; не совсем к месту. Создали кучу фикстур для тестирования различных ситуаций и закомитили.</p>

<p>К сожалению, пример попал в 7 или 8 из 10. Имена переменных вымышленные, но размер дата провайдера совершенно реален.</p>

<p>Тут самое время вернуться к статье о <a href="fightmaster.github.io/blog/2013/09/25/code-review.html">код ревью</a>. Система код ревью - это машина будущего, она переносит ваших коллег на полгода вперед, тем самым предоставляя возможность изменить ход событий, избежать тупления над кодом и тестом.</p>

<blockquote><p>При написании кода мы стараемся дать сразу понять: что делает метод, что возвращает, что хранит переменная и т.д.. </p><p>При написании теста мы стараемся показать сразу: что тестируем и какую ситуацию описывают входные данные и т.д..</p><footer><strong>fightmaster</strong> <cite><a href='http://fightmaster.github.io/blog/2013/09/23/unit-tests.html'>fightmaster.github.io/blog/2013/&hellip;</a></cite></footer></blockquote>

<p>И правда, а что тестируется в итоге? Вот упадет через полгода код на 15 варианте дата провайдера, и чем мне это поможет? Название какой-то фикстуры (о хорошем тоне именования фикстур в следующей серии) ни о чем нам не скажет. Ну пойдем, откроем ее, а дальше что? А вдруг Петя ее поменял, а за ним Саша. А кто из них был не прав? А вдруг в нашей системе изменились требования, и именно этот тест теперь не должен падать при таких условиях. В обшем ничерта непонятно.</p>

<p>Вторая сторона, это добавить что-то в тест. Мы не знаем куда именно добавлять наш вариант. Все равно куда - не дело. А может наш вариант уже добавлен?</p>

<p>Первое и самое простое, что приходит в голову, оставить просто пояснения, в двух или трех словах выражающие особенность этого кейса.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">checkSomethingRestrictionsProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">// model 1, pass</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">),</span>
        <span class="c1">// model 2, pass</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_2&#39;</span><span class="p">),</span>

        <span class="c1">// code</span>
        <span class="c1">// code</span>

        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_7&#39;</span><span class="p">),</span>
        <span class="c1">// model 8, pass</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_8&#39;</span><span class="p">),</span>
        <span class="c1">// model 9, pass</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_9&#39;</span><span class="p">),</span>
        <span class="c1">// model 1, unknown attribute, fail</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1">// model 2, unknown name, fail</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 2&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="c1">// model 3, no assign balck color, fail</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 3&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>

        <span class="c1">// code</span>
        <span class="c1">// code</span>

        <span class="c1">// model 16, unknown name, fail</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_16&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 16&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
        <span class="c1">// product WITH color specified, fail</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;invalid_model_17&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed 17&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Теперь мы хотя бы знаем, что хотели сказать авторы. Поддерживать тест теперь намного проще, порог вхождения в код сокращен.</p>

<h3>Бесконечность параметров</h3>

<p>В первых строках этой главы я завис на несколько минут. Все дело в том, что я очень редко вижу методы с большим набором входных параметров. Все знают, что это имеет плачевные последствия, и никто так не пишет нынче. Но почему-то все забывают эти правила при написании тестов. Мне кажется это феномен. Я наблюдал это в других проектах. Да, и где-то в глубине души существует искра надежды, что вы делали также.</p>

<p>Чаще всего в тесте нам нужно сконфигурировать определенную ситуацию. В предыдущей главе это достигалось с помощью фикстур. Часто используются моки или даже сами объекты, последнее конечно неправильно. Но в данных примерах именно они и будут. Так как работа с мок объектами - это целое искуство, и я не хочу все смешивать.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> * @backupGlobals enabled</span>
<span class="sd"> * @dataProvider getGlobalsProvider</span>
<span class="sd"> * </span>
<span class="sd"> * @param boolean $a</span>
<span class="sd"> * @param boolean $b</span>
<span class="sd"> * @param array $expectedResult</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getGlobals</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">,</span> <span class="nv">$expectedResult</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$a</span><span class="p">;</span>
    <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">;</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">getGlobals</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertSame</span><span class="p">(</span><span class="nv">$expectedResult</span><span class="p">,</span> <span class="nv">$result</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">getGlobalsProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;a_value&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span> <span class="s1">&#39;b_value&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">)),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;a_value&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span> <span class="s1">&#39;b_value&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">)),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;a_value&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span> <span class="s1">&#39;b_value&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">)),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;a_value&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span> <span class="s1">&#39;b_value&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">)),</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Такой вот незамысловатый пример. Через некоторое время использование дата провайдера таким образом превращается в привычку. И в результате...</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> * @dataProvider findBySearchMappingProvider</span>
<span class="sd"> *</span>
<span class="sd"> * @param string|null $color</span>
<span class="sd"> * @param string|null $size</span>
<span class="sd"> * @param integer|null $width</span>
<span class="sd"> * @param integer|null $length</span>
<span class="sd"> * @param integer|null $height</span>
<span class="sd"> * @param boolean|null $enabled</span>
<span class="sd"> * @param array $expectedReferences</span>
<span class="sd"> * @param integer $expectedResultCount</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBySearchMapping</span><span class="p">(</span><span class="nv">$color</span><span class="p">,</span> <span class="nv">$size</span><span class="p">,</span> <span class="nv">$width</span><span class="p">,</span> <span class="nv">$length</span><span class="p">,</span> <span class="nv">$height</span><span class="p">,</span> <span class="nv">$enabled</span><span class="p">,</span> <span class="nv">$expectedReferences</span><span class="p">,</span> <span class="nv">$expectedResultCount</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$expectedResults</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$expectedReferences</span> <span class="k">as</span> <span class="nv">$referenceName</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$expectedResults</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">referenceRepository</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="nv">$referenceName</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$searchMapping</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SearchMapping</span><span class="p">();</span>
    <span class="nv">$searchMapping</span><span class="o">-&gt;</span><span class="na">setColor</span><span class="p">(</span><span class="nv">$color</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setSize</span><span class="p">(</span><span class="nv">$size</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setWidth</span><span class="p">(</span><span class="nv">$width</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setLength</span><span class="p">(</span><span class="nv">$length</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setHeight</span><span class="p">(</span><span class="nv">$height</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setEnabled</span><span class="p">(</span><span class="nv">$enabled</span><span class="p">);</span>

    <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">findBySearchMapping</span><span class="p">(</span><span class="nv">$searchMapping</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertCount</span><span class="p">(</span><span class="nv">$expectedResultCount</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertContainsOnlyInstancesOf</span><span class="p">(</span><span class="s1">&#39;SomeInterface&#39;</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$expectedResults</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBySearchMappingProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span> <span class="mi">6</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_2&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;NOTEXIST&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">&#39;XL&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_5&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;XL&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;XL&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_2&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_3&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Когда это видишь первый раз на ревью, сначала прощаешь или не придаешь значение. Но команда - это лавина, особенно, если задание в релизе способствует появлению таких провайдеров. Иногда количество параметров достигало до 15. И в какой-то момент понимаешь, что надо брать ситуацию под контроль. Это осознание усиливается, когда в одном PR (Pull Request) несколько таких примеров. Что же делать?</p>

<p>Естественно, сначала оставляем комментарии, что-то вроде такого.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBySearchMappingProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">//$color, $size, $width, $length, $height, $enabled, $expectedReferences, $expectedResultCount</span>
        <span class="c1">//find all models</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span> <span class="mi">6</span><span class="p">),</span>
        <span class="c1">//find models by the color</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1">//find models by the color</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_2&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1">//trying find models by the non-existent color</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;NOTEXIST&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="c1">//find models by the size</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">&#39;XL&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span>
        <span class="c1">//find models by the size</span>
        <span class="k">array</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_5&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>

        <span class="c1">// code</span>
        <span class="c1">// code</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Так как это минимум умственных и временных затрат для достижения компромисса между программистом и владельцем продукта.</p>

<h3>Не комментируйте плохой код — перепишете его.</h3>

<p>Спустя время мы нашли несколько решений. До сих пор у меня нет объяснения, почему они сразу не всплыли. Вспомним цитату выше. Нам нужно всего лишь показать, что мы хотим протестировать. А многочисленные <code>null</code> лишь говорят о том, что эти значения нас не интересуют для этого теста.</p>

<p>Воспользуемся советом дядюшки Боба.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBySearchMappingProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">// find all models</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(),</span> 
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span>
             <span class="mi">6</span>
         <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;black&#39;</span><span class="p">),</span> 
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">),</span> 
            <span class="mi">1</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;red&#39;</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_2&#39;</span><span class="p">),</span>
            <span class="mi">1</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;NOTEXIST&#39;</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(),</span>
            <span class="mi">0</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;XL&#39;</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span>
            <span class="mi">5</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;M&#39;</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_5&#39;</span><span class="p">),</span>
            <span class="mi">1</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;XL&#39;</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">),</span>
            <span class="mi">1</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;M&#39;</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(),</span>
            <span class="mi">0</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;XL&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span> <span class="o">=&gt;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span> <span class="o">=&gt;</span> <span class="mi">23</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(),</span>
            <span class="mi">0</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span>
            <span class="mi">5</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_2&#39;</span><span class="p">),</span>
            <span class="mi">1</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;length&#39;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_3&#39;</span><span class="p">),</span>
            <span class="mi">1</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;length&#39;</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(),</span>
            <span class="mi">0</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;height&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">),</span>
            <span class="mi">2</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;height&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(),</span>
            <span class="mi">0</span>
        <span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Вуаля, ассоциативные массивы спасают этот мир. Ключ массива выступает в роли комментария, и необходимость онного чаще всего излишне теперь (хотя НЕ всегда). Осталось теперь поправить сам код теста.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> * @dataProvider findBySearchMappingProvider</span>
<span class="sd"> *</span>
<span class="sd"> * @param array $dataMapping</span>
<span class="sd"> * @param array $expectedReferences</span>
<span class="sd"> * @param integer $expectedResultCount</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBySearchMapping</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">,</span> <span class="nv">$expectedReferences</span><span class="p">,</span> <span class="nv">$expectedResultCount</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$expectedResults</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$expectedReferences</span> <span class="k">as</span> <span class="nv">$referenceName</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$expectedResults</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">referenceRepository</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="nv">$referenceName</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$searchMapping</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SearchMapping</span><span class="p">();</span>
    <span class="nv">$searchMapping</span><span class="o">-&gt;</span><span class="na">setColor</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setSize</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setWidth</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setLength</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setHeight</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;heigth&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setEnabled</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">);</span>

    <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">findBySearchMapping</span><span class="p">(</span><span class="nv">$searchMapping</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertCount</span><span class="p">(</span><span class="nv">$expectedResultCount</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertContainsOnlyInstancesOf</span><span class="p">(</span><span class="s1">&#39;SomeInterface&#39;</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$expectedResults</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h3>Рефакторинг</h3>

<p>Но негоже оставлять в таком виде тест, вдруг кто-то решит взять на заметку этот совет. </p>

<p>Во-первых, блок, получающий ожидаемые объекты, един как минимум для этого тест кейса. Во-вторых, тоже самое можно сказать про создание конфигурируемого объекта. При этом чаще всего это мок объект, и он используется в других тестах. В-третьих, я ненавижу параметр $expectedCounts, тем более когда есть набор ожидаемых объектов.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @test</span>
<span class="sd"> * @dataProvider findBySearchMappingProvider</span>
<span class="sd"> *</span>
<span class="sd"> * @param array $dataMapping</span>
<span class="sd"> * @param array $expectedReferences</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBySearchMapping</span><span class="p">(</span><span class="k">array</span> <span class="nv">$mappingData</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$expectedReferences</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$expectedResults</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getSomethingByReferences</span><span class="p">(</span><span class="nv">$expectedReferences</span><span class="p">);</span>
    <span class="nv">$searchMapping</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getSearchMapping</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">);</span>

    <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uut</span><span class="o">-&gt;</span><span class="na">findBySearchMapping</span><span class="p">(</span><span class="nv">$searchMapping</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertCount</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$expectedResults</span><span class="p">),</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertContainsOnlyInstancesOf</span><span class="p">(</span><span class="s1">&#39;SomeInterface&#39;</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$expectedResults</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @return array</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBySearchMappingProvider</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">// find all models</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(),</span> 
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">)</span>
         <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;black&#39;</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">)</span>
        <span class="p">),</span>

        <span class="c1">//code</span>

        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;XL&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span> <span class="o">=&gt;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span> <span class="o">=&gt;</span> <span class="mi">23</span><span class="p">),</span>
            <span class="k">array</span><span class="p">()</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;model_1&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3&#39;</span><span class="p">,</span> <span class="s1">&#39;model_4&#39;</span><span class="p">,</span> <span class="s1">&#39;model_5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_6&#39;</span><span class="p">)</span>
        <span class="p">),</span>

        <span class="c1">//code</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @param array $references</span>
<span class="sd"> * @return SomeInterface[]</span>
<span class="sd"> */</span>
<span class="k">private</span> <span class="k">function</span> <span class="nf">getSomethingByReferences</span><span class="p">(</span><span class="k">array</span> <span class="nv">$references</span><span class="p">)</span>
<span class="p">{</span>

    <span class="nv">$models</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$references</span> <span class="k">as</span> <span class="nv">$referenceName</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$models</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">referenceRepository</span><span class="o">-&gt;</span><span class="na">getReference</span><span class="p">(</span><span class="nv">$referenceName</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$models</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * @param array $mappingData</span>
<span class="sd"> * @return SearchMapping</span>
<span class="sd"> */</span>
<span class="k">private</span> <span class="k">function</span> <span class="nf">getSearchMapping</span><span class="p">(</span><span class="k">array</span> <span class="nv">$mappingData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$searchMapping</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SearchMapping</span><span class="p">();</span>
    <span class="nv">$searchMapping</span><span class="o">-&gt;</span><span class="na">setColor</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setSize</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setWidth</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setLength</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setHeight</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;heigth&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setEnabled</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$mappingData</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<h3>Заключение</h3>

<p>Последний мой PR содержал data provider для сложного поиска c около 70 вариантами. И знаете, он выглядит &quot;удобоваримо&quot;. Я придерживаюсь такого правила, если, прокручивая провайдер колесиком мышки, вы все прекрасно понимаете - значит проверка на качество пройдена.</p>

</div>

<footer>
    <p class="meta">
        
<span class="byline author vcard">Posted by <span class="fn">fightmaster</span></span>

        

<span class="categories">
  
    unit testsdata providerclean codecode reviewphp

    
        Категории
        clean code, code review, data provider, php, unit tests
    
  
</span>


    </p>

    

    
    <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://fightmaster.github.io//blog/2013/10/05/unit-tests-data-provider-without-a-headache.html" data-via="old_fightmaster" data-counturl="http://fightmaster.github.io//blog/2013/10/05/unit-tests-data-provider-without-a-headache.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
        
        <a class="basic-alignment left" href="/blog/2013/09/28/ohio-river-greenway-5-k.html" title="Previous Post: Ohio River Greenway 5K">&laquo; Ohio River Greenway 5K</a>
        
        
        <a class="basic-alignment right" href="/blog/2013/10/17/the-whole-point-is-that-it-happens.html" title="Next Post: Все дело в том, что так бывает...">Все дело в том, что так бывает... &raquo;</a>
        
    </p>
</footer>

<section>
    <div class="related">
      <h2>Related Posts</h2>
      <ul class="related-posts">
        
          <li>
            <h4>
              <a href="/blog/2017/01/07/doroga-21.html">
                Дорога 21
                <small>07 Jan 2017</small>
              </a>
            </h4>
          </li>
        
          <li>
            <h4>
              <a href="/blog/2014/11/20/sredi-stikhij-2014.html">
                Среди Стихий 2014
                <small>20 Nov 2014</small>
              </a>
            </h4>
          </li>
        
          <li>
            <h4>
              <a href="/blog/2014/09/29/object-search-optimization.html">
                Оптимизация. Поиск/хранилище временных объектов
                <small>29 Sep 2014</small>
              </a>
            </h4>
          </li>
        
      </ul>
    </div>
</section>


<section>
    <h1>Комментарии</h1>
    <div aria-live="polite"><!-- Put this div tag to the place, where the Comments block will be -->
<div id="vk_comments"></div>
<script type="text/javascript">
    VK.Widgets.Comments("vk_comments", {limit: 10, width: "665", attach: "*"});
</script>
</div>
</section>


    </div>

        
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


        
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


        
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


    </body>
</html>
